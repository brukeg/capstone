{% extends "home/base.html" %}

{% block plaid %}
  <html>
  <head>
    <title>Django Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  </head>
  <body></body>
  <script>
      $(document).ready(function () {
          console.log('page is loaded ...');
          var handler = Plaid.create({
              clientName: 'Plaid Quickstart',
              env: 'sandbox',
              key: 'fa9dd19eb40982275785b09760ab79',
              product: ['auth'],
              // Optional â€“ use webhooks to get transaction and error updates
              webhook: 'https://requestb.in',
              onLoad: function () {
                  // Optional, called when Link loads
              },
              onSuccess: function (public_token, metadata) {
                  // Send the public_token to your app server.
                  // The metadata object contains info about the institution the
                  // user selected and the account ID or IDs, if the
                  // Select Account view is enabled.
                  console.log({
                      "public_token": public_token,
                      "user_handle": $('#handle').val(),
                      "private_key": $('#key').val(),
                  });
                  // $.post('/linkAccount', {
                  //   "public_token": public_token,
                  //   "user_handle": $('#handle').val(),
                  //   "private_key": $('#key').val(),
                  // });
                  $.ajax({
                      type: 'POST',
                      url: '/linkAccount',
                      data: JSON.stringify({
                          public_token: public_token,
                          user_handle: $('#handle').val(),
                          private_key: $('#key').val(),
                      }),
                      dataType: 'json',
                      contentType: 'application/json;charset=utf-8',
                      success: function (res) {
                          console.log('success');
                      },
                      failure: function (err) {
                          console.log('error');
                      },
                  });
              },
              onExit: function (err, metadata) {
                  // The user exited the Link flow.
                  if (err != null) {
                      // The user encountered a Plaid API error prior to exiting.
                  }
                  // metadata contains information about the institution
                  // that the user selected and the most recent API request IDs.
                  // Storing this information can be helpful for support.
              },
              onEvent: function (eventName, metadata) {
                  // Optionally capture Link flow events, streamed through
                  // this callback as your users connect an Item to Plaid.
                  // For example:
                  // eventName = "TRANSITION_VIEW"
                  // metadata  = {
                  //   link_session_id: "123-abc",
                  //   mfa_type:        "questions",
                  //   timestamp:       "2017-09-14T14:42:19.350Z",
                  //   view_name:       "MFA",
                  // }
              }
          });
          $('#link-account').on('click', function (e) {
              handler.open();
          });
      });
  </script>
  </html>
{% endblock %}